#!/usr/bin/env bash
# Setup Thunderbird github repo using git-cinnabar

set -euo pipefail
IFS=$'\n\t'

# ============================================================================
# Configuration
# ============================================================================

HG_URL="hg::https://hg-edge.mozilla.org/comm-unified"
TARGET_DIR=""
GITHUB_URL=""
# Behavior flags (set by CLI)
FORCE_PUSH=false
PUSH=false

# Bookmarks to create branches from
BOOKMARKS=(
  comm
  comm-beta
  comm-release
  comm-esr115
  comm-esr128
  comm-esr140
)

# ============================================================================
# Functions
# ============================================================================

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

This script migrates the Thunderbird Mercurial repository (comm-unified) to Git
using git-cinnabar. It clones from hg, fetches specified bookmarks, creates local
git branches and optionally pushes to GitHub.

OPTIONS:
  --github-url URL
      GitHub repository URL to push to.

  --target-dir DIR
      Local directory name for the cloned repository.
      Default: Derived from the GitHub repository name (e.g., thunderbird-desktop-staging)

  --force-push
      Force-push to GitHub, overwriting all remote refs. Use this for initial
      repository creation or to completely overwrite the existing repository.
      Deletes all existing branches and tags on remote before pushing.
      WARNING: This is destructive and will overwrite the remote repository.

  --push
      Push branches/tags to GitHub without force.
      Intended for subsequent runs after an initial force push.
      Only fast-forward updates are allowed; if the remote diverged, the push will fail.

  -h, --help
      Show this help message and exit.

WORKFLOW:
  1. Basic migration (no push):
    ./$(basename "$0") --github-url https://github.com/thunderbird/thunderbird-desktop-staging

  2. Force-push migration (overwrite remote; initial seeding / recovery):
    ./$(basename "$0") --github-url https://github.com/thunderbird/thunderbird-desktop-staging --force-push

  3. Incremental push (no force; subsequent runs):
    ./$(basename "$0") --github-url https://github.com/thunderbird/thunderbird-desktop-staging --push

EOF
}

die() {
  echo "Error: $*" >&2
  exit 1
}

bookmark_to_branch() {
  local bookmark="$1"
  local branch="${bookmark#comm-}"
  if [[ "$bookmark" == "comm" ]]; then
    echo "main"
  else
    echo "$branch"
  fi
}

ensure_remotes() {
  local gh_url="$1"

  local origin_url
  origin_url="$(git remote get-url origin 2>/dev/null || true)"

  # If origin is still pointing at Mercurial, rename it to hg.
  if [[ -n "$origin_url" && "$origin_url" == hg::* ]]; then
    if git remote | grep -Fxq hg; then
      # Prefer existing hg remote; just repoint origin to GitHub.
      echo "Found Mercurial URL on origin but hg remote already exists; keeping hg as-is."
    else
      echo "Renaming Mercurial remote 'origin' -> 'hg'"
      git remote rename origin hg
      origin_url=""
    fi
  fi

  # Ensure hg remote exists and points at HG_URL.
  if git remote | grep -Fxq hg; then
    git remote set-url hg "$HG_URL"
  else
    echo "Adding Mercurial remote 'hg' -> $HG_URL"
    git remote add hg "$HG_URL"
  fi

  # Ensure origin remote exists and points at GitHub.
  if git remote | grep -Fxq origin; then
    git remote set-url origin "$gh_url"
  else
    echo "Adding GitHub remote 'origin' -> $gh_url"
    git remote add origin "$gh_url"
  fi
}

ensure_branch_can_fast_forward() {
  local branch="$1"

  if ! git show-ref --verify --quiet "refs/heads/${branch}"; then
    die "Local branch refs/heads/${branch} does not exist"
  fi

  local remote_sha
  remote_sha="$(git ls-remote --heads origin "refs/heads/${branch}" | awk '{print $1}')"
  if [ -z "$remote_sha" ]; then
    echo "origin/${branch} does not exist yet (will create)"
    return 0
  fi

  echo "Verifying ${branch} can fast-forward origin/${branch}"

  # Fetch the remote commit so merge-base has it locally
  if ! git fetch --quiet --no-tags origin "${remote_sha}"; then
    die "Failed to fetch ${remote_sha} from origin. Remote may have rewritten history or access is misconfigured."
  fi

  if git merge-base --is-ancestor "${remote_sha}" "${branch}"; then
    echo "origin/${branch} can fast-forward"
    return 0
  fi

  # Can't fast-forward
  die "Refusing to push: ${branch} cannot fast-forward origin/${branch} (branches have diverged or local is behind)"
}

# ============================================================================
# Argument Parsing
# ============================================================================

while [[ ${1:-} != "" ]]; do
  case "$1" in
    --target-dir) TARGET_DIR="$2"; shift 2;;
    --github-url) GITHUB_URL="$2"; shift 2;;
    --push) PUSH=true; shift 1;;
    --force-push) FORCE_PUSH=true; shift 1;;
    -h|--help) usage; exit 0;;
    *) echo "Unknown arg: $1"; usage; exit 2;;
  esac
done

# Validate required arguments
if [ -z "$GITHUB_URL" ]; then
  echo "Error: --github-url is required" >&2
  usage
  exit 1
fi

# Derive target directory from GitHub URL if not specified
if [ -z "$TARGET_DIR" ]; then
  TARGET_DIR=$(basename "$GITHUB_URL" .git)
  echo "Using default target directory: $TARGET_DIR"
fi

# ============================================================================
# Main Execution
# ============================================================================

# Ensure git-cinnabar exists (try to install if cargo is available)
if ! command -v git-cinnabar &>/dev/null; then
  if command -v cargo &>/dev/null; then
    echo "git-cinnabar not found, installing via cargo..."
    cargo install --locked git-cinnabar
  else
    die "git-cinnabar is required but not installed. Please install cargo or git-cinnabar manually."
  fi
fi

# Clone if necessary
if [ ! -d "$TARGET_DIR" ]; then
  git clone "$HG_URL" "$TARGET_DIR"
elif [ -d "$TARGET_DIR/.git" ]; then
  echo "Repository already exists and appears to be a git repo at $TARGET_DIR"
else
  die "Target directory $TARGET_DIR exists but is not a git repository"
fi

cd "$TARGET_DIR"

# Setup remotes (hg for Mercurial, origin for GitHub)
ensure_remotes "$GITHUB_URL"

# Make fetch operations prune by default
git config fetch.prune true || true

# Local git hook to make git status and friends faster
if [ -f .git/hooks/fsmonitor-watchman.sample ]; then
  if [ ! -e .git/hooks/query-watchman ]; then
    echo "Installing query-watchman hook (copying sample)..."
    cp .git/hooks/fsmonitor-watchman.sample .git/hooks/query-watchman
    git config core.fsmonitor .git/hooks/query-watchman || true
  else
    echo "query-watchman hook already present, skipping"
  fi
fi

# Fetch bookmarks and create local branches
for bookmark in "${BOOKMARKS[@]}"; do
  branch=$(bookmark_to_branch "$bookmark")
  refspec="refs/heads/bookmarks/${bookmark}:refs/remotes/hg/${branch}"

  echo "Ensure fetch for ${bookmark} -> hg/${branch}"
  # Only add if it does not already exist
  if ! git config --get-all remote.hg.fetch | grep -Fxq "$refspec"; then
    git config --add remote.hg.fetch "$refspec"
  else
    echo "  fetch refspec already present, skipping"
  fi

  echo "Fetching ${bookmark}..."
  # fetch the refspec to ensure mapping from hg bookmark -> origin/${branch}
  git fetch --no-tags hg "$refspec" || true

  # Create local branch from the fetched remote
  if git show-ref --verify --quiet "refs/remotes/hg/${branch}"; then
    echo "Creating/updating local branch: ${branch}"
    git checkout -B "$branch" "refs/remotes/hg/${branch}"
    commit_sha="$(git rev-parse --short "refs/remotes/hg/${branch}")"
    echo "  -> ${commit_sha} $(git log -1 --format=%s "refs/remotes/hg/${branch}")"
  else
    echo "hg/${branch} not found; skipping branch ${branch}"
  fi
done

# Fetch Mercurial tags
echo
echo "Fetching Mercurial tags..."
if git cinnabar fetch --tags; then
  tag_count=$(git tag | wc -l)
  echo "Successfully fetched ${tag_count} tags from Mercurial"
else
  die "Tag fetch failed"
fi

# Force push or push
echo
if [ "$FORCE_PUSH" = true ]; then
  echo "Force-push mode enabled via --force-push flag"
elif [ "$PUSH" = true ]; then
  echo "Non-force push mode enabled via --push flag"
else
  echo "No push requested: will not modify the GitHub remote."
fi

echo "Remotes configured: hg -> $(git remote get-url hg), origin -> $(git remote get-url origin)"

if [ "$FORCE_PUSH" = true ]; then
  echo "Preparing to force-push branches to ${GITHUB_URL}"

  # Delete all existing refs (branches, tags, bookmarks, etc.) on the remote before force-pushing
  echo "Deleting all existing refs on origin (GitHub)..."
  git ls-remote origin | grep -v 'HEAD' | while read -r sha ref; do
    echo "  Deleting ${ref}"
    # Use refspec deletion (push empty ref) which works for all ref types
  git push --quiet origin ":${ref}" 2>/dev/null || true
  done

  # Push branches
  for bookmark in "${BOOKMARKS[@]}"; do
    branch=$(bookmark_to_branch "$bookmark")
    if git show-ref --verify --quiet "refs/heads/${branch}"; then
      echo "Force-pushing ${branch} to origin/${branch}"
      git push --quiet --force origin "refs/heads/${branch}:refs/heads/${branch}"
    fi
  done
elif [ "$PUSH" = true ]; then
  echo "Pushing branches to ${GITHUB_URL} (no force; fast-forward only)"
  echo "Ensure we can fast-forward before pushing before pushing..."
  for bookmark in "${BOOKMARKS[@]}"; do
    branch=$(bookmark_to_branch "$bookmark")
    ensure_branch_can_fast_forward "$branch"
  done

  for bookmark in "${BOOKMARKS[@]}"; do
    branch=$(bookmark_to_branch "$bookmark")
    if git show-ref --verify --quiet "refs/heads/${branch}"; then
      echo "Pushing ${branch} to origin/${branch}"
      git push --quiet origin "refs/heads/${branch}:refs/heads/${branch}"
    fi
  done
else
  echo "Push not requested"
fi

# Push all tags to GitHub
echo
if [ "$FORCE_PUSH" = true ]; then
  echo "Force-pushing all tags to origin..."
  if git push --quiet --force origin --tags; then
    echo "Tags force pushed successfully"
  else
    die "Force push tags failed"
  fi
elif [ "$PUSH" = true ]; then
  echo "Pushing tags to origin (no force)"
  if git push --quiet origin --tags; then
    echo "Tags pushed successfully"
  else
    die "push tags failed (remote may have diverged tags)"
  fi
fi

echo
echo "Thunderbird repo $TARGET_DIR setup complete!"
if [ "$FORCE_PUSH" = true ]; then
  echo "Force-push completed. Subsequent updates can use --push (no force)."
elif [ "$PUSH" = true ]; then
  echo "Push completed (no force)."
else
  echo "No push performed. Re-run with --push (incremental) or --force-push (destructive)."
fi
